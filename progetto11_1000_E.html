<!DOCTYPE html>
<html>
<head>
</head>
<body>
	<div>
		<button id="rec">Rec</button>
		<button id="play">Play</button>
		<button id="harm">Harm</button>
	</div>
	<script type="text/javascript">
		
		var i = 0;
		var note_array = new Array;
		var chord_array = new Array;
		var block = new Array;
		var j = 0; 
		var j_eq;
		var jj = 0;
		var jjj;
		var m = 1;
		var send = false;
		var counter = 1;
		var francoisPachet;

		var note_duration = new Array;
		var note_time = new Array;
		var noteOn = new Array;	
		var chord_duration = new Array;
		var chord_time = new Array;
		var chordOn = new Array;
		var davidelogiri = 0;
		var stevenwilson = 0;
		var num_note = new Array;
		var min_midi_freq = 21;
		var min_keyb_freq = 27.5;

		document.querySelectorAll("#rec").forEach(toggleRecord);
		
		function toggleRecord(item){
			item.onclick = record;
		}
		
		function record(){
			send = !send;
			console.log(send + " record");
			if (send){
				navigator.requestMIDIAccess().then(onMIDISuccess);
				francoisPachet = s_m;
			}
			else{
				/*console.log("else");
				while (j < note_array.length){
				block[j/10]  = note_array.slice(j,j+10);
				j = j+10;
				}*/
				//counter = i;
				davidelogiri = i;
				stevenwilson = j;
				makeChordDuration();
				//getMinNote();
			}
		}
		
		function onMIDISuccess(midiAccess) {
			console.log(midiAccess);
		    inputs = midiAccess.inputs;
		    outputs = midiAccess.outputs;
		    
		    for (var input of midiAccess.inputs.values()){
		        input.onmidimessage = getMIDIMessage;
		    }
		}

		function getMIDIMessage(midiMessage) {
			message = midiMessage;
			
			if (message.data[0] == 155 || message.data[0] == 139){ //message from channel 12 (MELODY)
				note_array[i] = message.data;
				note_time[i] = message.timeStamp;
				getDurationNotes(i, note_array, note_time, note_duration, noteOn, davidelogiri);
				i++;
			} else if (message.data[0] == 144 || message.data[0] == 128){ //message from channel 1 (CHORDS)
				chord_array[j] = message.data;
				chord_time[j] = message.timeStamp;
				j++;
			}
			
			/*for (i=1;i<note_array.length;i++){
				noteOn[i] = (note_array[i][0] < note_array[i-1][0]);
				console.log(noteOn[i] + " " + note_duration[i]);
			}*/
		}
		//notePerChord(chord_array);

		function getDurationNotes(index, array_type, time_type, duration_type, noteOn_type, last_note){
			if (index>0){
				if (index == last_note){				
					duration_type[index] = 200; //arbitrary duration of 200 ms
				} else {
					duration_type[index] = time_type[index] - time_type[index-1];
				}
				noteOn_type[index] = (array_type[index][0] < array_type[index-1][0]);
				//console.log(noteOn_type[index] + " " + duration_type[index]);
			}
		}

		//quanti accordi suonano eda quante note sono formati
		var n = 0;
		var min_note;
		var min_note_index = 0;
		var shaiMaestro = new Array; //array che contiene i dati delle note minime di ogni accordo
		var avishaiCohen = new Array;
		var s_m = 0;

		function getMinNote(){
			min_note = chord_array[0][1];
			while (m<chord_array.length){
				if (chord_array[m][0] == chord_array[m-1][0]){
					if (Math.min(min_note, chord_array[m][1]) == chord_array[m][1]){
						min_note = chord_array[m][1];
						min_note_index = m; 
					}
					m++;
				}
				else {
					shaiMaestro[s_m] = chord_array[min_note_index];
					avishaiCohen[s_m] = chord_time[min_note_index];
					s_m++;
					m++;
					min_note = chord_array[m-1][1];
					min_note_index = m-1;
				} 
			}
			shaiMaestro[s_m] = chord_array[min_note_index];
			avishaiCohen[s_m] = chord_time[min_note_index];
		}
/*
		function makeChordDuration(){
			getMinNote();
			for (var chord_i = 1; chord_i<shaiMaestro.length; chord_i++){
				getDurationNotes(chord_i, shaiMaestro, avishaiCohen, chord_duration, chordOn, stevenwilson);
			}
		}
*/

	
		var harm_array = new Array;
		var dur_harm = new Array;
		var harm_i;

		function makeChordDuration(){
			getMinNote();
			dur_harm = dur_harm.concat(Array((shaiMaestro.length-francoisPachet)*2 - 1));
			for (var chord_i = 1; chord_i<shaiMaestro.length; chord_i++){
				getDurationNotes(chord_i, shaiMaestro, avishaiCohen, chord_duration, chordOn, stevenwilson);
				harm_i = chord_i * 2 - 1;
				dur_harm.fill(chord_duration[chord_i]/2,harm_i,harm_i+2);
			}
			console.log(dur_harm);
		}
/*
		function durationHarm(){
			dur_harm.concat(Array(shaiMaestro.length*2));
			console.log(dur_harm);

		}
*/
	
		document.querySelectorAll("#play").forEach(togglePlay);
		
		function togglePlay(item){
			item.onclick = startplaying;
		}
		
		var k = 1;
		var c;
		
		function startplaying(){
			//if (k<noteOn.length){
			if (k<note_array.length){
				midi_freq = note_array[k-1][1] // midi freq of the note being played
				keyb_freq = min_keyb_freq*Math.pow(2,(midi_freq - min_midi_freq)**1/12);
				if (noteOn[k]){
					suona(keyb_freq);
					console.log(midi_freq + " = " + keyb_freq + " durata " + note_duration[k] + " ON");
					setTimeout(startplaying, note_duration[k]);
					//setTimeout(console.log(" k = "+k),duration[k]);
				} else{
					console.log(midi_freq + " = " + keyb_freq + " durata " + note_duration[k] + " OFF");
					setTimeout(startplaying, note_duration[k]);
					//setTimeout(console.log(" k = "+k),duration[k]);
					
				}
			k++;
			}
		}

		function suona(freq){
			c = new AudioContext();
		    osc = c.createOscillator();
		    osc.connect(c.destination);
		    osc.frequency.value = freq;
		    osc.start();
		    osc.stop(note_duration[k]/1000);
		}

		/*var e = 0;
		while (e < chord_array.length){
			block[e/5]  = chord_array.slice(e,e+5);
			e = e+5;
		}*/



		/*function getDurationChords(){ 
			chord_duration[0] = 200; //arbitrary duration of 200 ms
			if (chord_array[j_eq-1][0] == 144){
				while (chord_array[j_eq][0] == 144){
					counter++;
					j_eq++;
				}
				while (jj<counter){
					chord_duration[jj] = chord_time[j_eq] - chord_time[j_eq-1];
					jj++;
				}
			}
			if (chord_array[j_eq-1][0] == 128){
				while (chord_array[j_eq][0] == 128){
					counter++;
					j_eq++;
				}
				while (jj<counter){
					chord_duration[jj] = chord_time[j_eq] - chord_time[j_eq-1];
					jj++;
				}
			}
			return chord_duration;
		}*/


	</script>
</body>
</html>


