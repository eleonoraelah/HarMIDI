<!DOCTYPE html>
<html>
<head>
</head>
<body>
	<div>
		<button id="rec">Rec</button>
		<button id="play">Play</button>
		<button id="harm">Harm</button>
		<button id="chords">Chords</button>
	</div>
	<script type="text/javascript">
		
		var i=0;
		var note_array = new Array;
		var chord_array = new Array;
		var block = new Array;
		var j = 0; 
		var send=false;
		var chord = false;
		var stevenwilson = 0;
		
		var pinco = 0;
		var note_duration = new Array;
		var note_time = new Array;
		var noteOn = new Array;	
		var chord_duration = new Array;
		var chord_time = new Array;
		var chordOn = new Array;
		var min_midi_freq = 21;
		var min_keyb_freq = 27.5;

		document.querySelectorAll("#rec").forEach(toggleRecord);
		
		function toggleRecord(item){
			item.onclick = record;
		}
		
		function record(){
			send = !send;
			console.log(send + " record");
			if (send){
				navigator.requestMIDIAccess().then(onMIDISuccess);
			} else{
				/*console.log("else");
				while (j < note_array.length){
				block[j/10]  = note_array.slice(j,j+10);
				j = j+10;
				}*/
				pinco = i;
				chordtimebase();
			}
		}
		
		function onMIDISuccess(midiAccess) {
			console.log(midiAccess);
		    inputs = midiAccess.inputs;
		    outputs = midiAccess.outputs;
		    
		    for (var input of midiAccess.inputs.values()){
		        input.onmidimessage = getMIDIMessage;
		    }
		}
		
		function getMIDIMessage(midiMessage) {
			message = midiMessage;
			if (message.data[0] == 155 || message.data[0] == 139){
				note_array[i]=message.data;
				note_time[i] = message.timeStamp;
				if (i > 0){
					if (i == pinco){
						note_duration[i] = 200; //arbitrary duration
					} else{
						note_duration[i] = note_time[i] - note_time[i-1];
					}
					noteOn[i] = (note_array[i][0] < note_array[i-1][0]);
					console.log(noteOn[i] + " " + note_duration[i]);
				}
				/*extractData(i,note_array,note_time,note_duration, noteOn);
				//console.log(message);*/
				i++;
			} else if (message.data[0] == 144 || message.data[0] == 128){
				/*extractData(j,chord_array,chord_time,chord_duration, chordOn);
				j++;*/
				chord = true;
				chord_array[stevenwilson]=message.data;
				chord_time[stevenwilson] = message.timeStamp;
/*
				if (slow_i>0){
					fast_i = slow_i-1;,
					davidelogiri = 1;
					while (fast_i>=0){
						if (chord_array[fast_i][1] != chord_array[slow_i][1]){
							fast_i--;
							davidelogiri++;
						} else {
							//chord_duration[slow_i] = chord_time[slow_i]-chord_time[fast_i];
							chord_duration[shaiMaestro].fill(chord_time[slow_i] - chord_time[fast_i], davidelogiri);
							chordOn[slow_i] = (chord_array[slow_i][0] < chord_array[fast_i][0]);
							fast_i = -1;
							
							while (shaiMaestro<shaiMaestro+davidelogiri){
								chord_duration[shaiMaestro] = chord_time[slow_i] - chord_time[fast_i];
								shaiMaestro++;
							}
						}
					}
				}*/
				stevenwilson++;
			}
		}

		var shaiMaestro = 0;
		var davidelogiri;
		var slow_i = 1;
		var fast_i;
		var min_note;
		var minNoteDuration = new Array;

		function chordtimebase(){
			chord_duration = Array(chord_time.length); //problema: quando rifaccio play dal midi poi mi cancella tutto 
			//Se io riuscissi a salvarmi la durata delle cose che mi interessano in teoria potrei anche fregarmene 
			//perchè senza di questo array() non riesco a fare il fill
			while (slow_i<chord_array.length){
				fast_i = slow_i-1;
				davidelogiri = 1;
				while (fast_i>=0){
					if (chord_array[fast_i][1] != chord_array[slow_i][1]){
						min_note = Math.min(chord_array[fast_i][1],chord_array[slow_i][1]); //per trovare la nota minima di cui prendere la durata per fare l'harm
						fast_i--;
						davidelogiri++;
					} else {
						//chord_duration[slow_i] = chord_time[slow_i]-chord_time[fast_i];
						chord_duration.fill(chord_time[slow_i] - chord_time[fast_i],slow_i,slow_i + davidelogiri); //facevamo il fill male ahahha
						chordOn[slow_i] = (chord_array[slow_i][0] < chord_array[fast_i][0]);
						minNoteDuration[shaiMaestro] = [min_note, chord_time[slow_i] - chord_time[fast_i],chordOn[slow_i]];
						//nella riga sopra c'è un tentativo vano di salvare nota minima e durata
						shaiMaestro++;
						fast_i = -1;
						slow_i = slow_i+davidelogiri-1;
						/*
						while (shaiMaestro<shaiMaestro+davidelogiri){
							chord_duration[shaiMaestro] = chord_time[slow_i] - chord_time[fast_i];
							shaiMaestro++;
						}*/
					}
				}
				slow_i++;	
			}
		}

		document.querySelectorAll("#play").forEach(togglePlay);
		
		function togglePlay(item){
			item.onclick = startplaying;
		}
		
		var k = 1;
		var c;
		
		function startplaying(){
			//if (k<noteOn.length){
			if (k<note_array.length){
				midi_freq = note_array[k-1][1] // midi freq of the note being played
				keyb_freq = min_keyb_freq*Math.pow(2,(midi_freq - min_midi_freq)**1/12);
				if (noteOn[k]){
					suona(keyb_freq);
					console.log(midi_freq + " = " + keyb_freq + " durata " + note_duration[k] + " ON");
					setTimeout(startplaying, note_duration[k]);
					//setTimeout(console.log(" k = "+k),duration[k]);
				} else{
					console.log(midi_freq + " = " + keyb_freq + " durata " + note_duration[k] + " OFF");
					setTimeout(startplaying, note_duration[k]);
					//setTimeout(console.log(" k = "+k),duration[k]);
					
				}
			k++;
			}
		}

		function suona(freq){
			c = new AudioContext();
		    osc = c.createOscillator();
		    osc.connect(c.destination);
		    osc.frequency.value = freq;
		    osc.start();
		    osc.stop(note_duration[k]/1000);
		}

		var e = 0;
		while (e < chord_array.length){
			block[e/5]  = chord_array.slice(e,e+5);
			e = e+5;
		}
			//return block;

		//createBlocks();

		/*document.querySelectorAll("#chords").forEach(togglePlayChords);
		
		function togglePlayChords(item){
			item.onclick = startPlayingChords;
		}

		function startPlayingChords(){
			for (var c=0;c<chord_array.length;c++){
				playChord(chord_array[c][1],chord_duration[k]);
			}
		}

		function playChord(array,dur){
			audioCtx = new AudioContext();
			osc_chord = audioCtx.createOscillator();
			osc_chord.connect(audioCtx.destination);
			osc_chord.frequency.value = array[k];
			osc_chord.start();
			osc_chord.stop(dur/1000);
		}*/



	</script>
</body>
</html>