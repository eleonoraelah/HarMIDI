<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">

	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

	<style type="text/css">
	    body{background-color:#FF8C00;}  /*#FF8C00*/

		button{
			position:relative;
			cursor:pointer;
			outline:none;
			font-family: georgia;
		}

		h2{
			position:relative;
			text-align:center;
			font-family: georgia;
			font-size: 150%;
			margin-top: 2%;
		}

		.container{
			position:relative;
			text-align:center;
		}

		h5{
			font-family: georgia;
			margin-top: 5%;
		}

    </style>
</head>
<body>
	<h2>Progetto di un armonizzatore e sintetizzatore di una sequenza midi in ingresso</h2>
	<div>
		<div id="container_1" class="container">
			<h5>Click "rec" to start aquiring data:</h5>
			<button id="rec" class="btn btn-success">Record input data</button>
		</div>
		<div id="container_2" class="container">
			<h5>Click "play" to play the input sequence:</h5>
			<button id="play" class="btn btn-success">Play</button>
		</div>
		<div id="container_3" class="container">
			<h5>Click "Harm" one time to listen to the perfect 5th harmonization;
			Click two times to listen to the perfect 4th harmonization</h5>
			<button id="harm" class="btn btn-success">Harmonized version</button>
		</div>
	</div>

	<script type="text/javascript">
		var i=0;
		var note_array = new Array;
		var block = new Array;
		var j = 0; 
		var send=false;
		
		var duration = new Array;
		var time = new Array;
		var noteOn = new Array;	
		var note= new Array;

		var midi_notes = new Array;
		var synth_notes = new Array;
		var note_to_play = new Array;

		//var min_midi_freq = 21;
		//var min_keyb_freq = 27.5;

		//converts midi notes into the corresponding frequency
		function MidiNotes(){
			//midi_notes contains the values of the midi notes
			var k = 0;
			for (l=21;l<=108;l++){
				midi_notes[k] = l;
				k++;
			}

			//Synth_notes contains the frequency of all the keyboard's notes
			synth_notes[0] = 27.5;
			for (m=1;m<midi_notes.length;m++){
				synth_notes[m]=synth_notes[m-1]*Math.pow(2,1/12);
				//synth_notes[m] = Math.round(synth_notes[m]);
			}
		}
		
		MidiNotes();

		document.querySelectorAll("#rec").forEach(toggleRecord);
		
		function toggleRecord(item){
			item.onclick = record;
		}
		
		function record(){
			send = !send;
			console.log(send + " record");
			if (send){
				navigator.requestMIDIAccess().then(onMIDISuccess);
			}
			else{
				console.log("else");
				while (j < note_array.length){
				block[j/10]  = note_array.slice(j,j+10);
				j = j+10;
				}
			}
		}
		
		function onMIDISuccess(midiAccess) {
			console.log(midiAccess);
		    inputs = midiAccess.inputs;
		    outputs = midiAccess.outputs;
		    
		    for (var input of midiAccess.inputs.values()){
		        input.onmidimessage = getMIDIMessage;
		    }
		}
		
		function getMIDIMessage(midiMessage) {
			message = midiMessage;

			if (message.data[0] == 155 || message.data[0] == 139){
				//console.log(message);
				note_array[i]=message.data;
				note[i] = message.data[1];
				synthMidiInput();
				time[i] = message.timeStamp;

				/*if (i == 0){
					duration[i] = time[0];

					if (note_array[i][0] == 139){
						noteOn[i] = true;
						console.log(duration[i] + " durata" + "ON");
					}else if (note_array[i][0] == 155){
						noteOn[i] = false;
						console.log(duration[i] + " durata" + "OFF");
					}
				}*/
				
				if (i > 0){
					duration[i] = time[i] - time[i-1];
					console.log(duration[i-1] + " durata");
					if (note_array[i][0] < note_array[i-1][0]){ //139 < 155 the note has been played
						noteOn[i] = true;
						console.log(duration[i]+" durata "+ note[i-1] + " ON");
					} else {
						noteOn[i] = false;
						console.log(duration[i]+" durata "+ note[i-1] + " OFF");
					}
				}
				i++;
			}
		}

		//converts the second value of the midi input in a playable note
		function synthMidiInput(){
			n=0;
			while (n<note.length){
				if (note[n]<21 | note[n]>108){
					//console.log('This is not a midi note');
					note_to_play[n] = 0;
				}else{
					p=0;
					while (midi_notes[p] != note[n]){
						p++;
					}
					//note_to_play[n] = Math.round(synth_notes[p]);   
					note_to_play[n] = Math.round(synth_notes[p]);   

				}
				n++;
			}
			return note_to_play;
		}

		document.querySelectorAll("#play").forEach(togglePlay);

		function togglePlay(item){
			item.onclick = startplaying;
		}

		var k = 1;
		var c;

		function startplaying(){
			if (k<note_to_play.length){
				if (noteOn[k]){
					suona(note_to_play[k]);
					console.log("freq =" + note_to_play[k] + " durata " + duration[k] + " ON");
					setTimeout(startplaying, duration[k]);
					//setTimeout(console.log(" k = "+k),duration[k]);
				} else{
					console.log("freq =" + note_to_play[k] + " durata " + duration[k] + " OFF");
					setTimeout(startplaying, duration[k]);
					//setTimeout(console.log(" k = "+k),duration[k]);
					
				}
			k++;
			}
		}

		function suona(freq){
			c = new AudioContext();
		    osc = c.createOscillator();
		    osc.connect(c.destination);
		    osc.frequency.value = freq;
		    osc.start();
		    osc.stop(duration[k]/1000);
		}

	</script>
</body>
</html>