<!DOCTYPE html>
<html>
<head>
</head>
<body>
	<div>
		<button id="rec">Rec</button>
		<button id="play">Play</button>
		<button id="harm">Harm</button>
	</div>
	<script type="text/javascript">

		var i = 0;
		var note_array = new Array;
		var block = new Array;
		var j = 0; 
		var send=false;
		var audioCtx = new AudioContext();
		var osc = audioCtx.createOscillator();
		var gain = audioCtx.createGain();
		var midi_notes = new Array;
		var synth_notes = new Array;
		var note_to_play = new Array;


		//midi_notes contains the values of the midi notes
		var k = 0;
		for (l=21;l<=108;l++){
			midi_notes[k] = l;
			k++;
		}


		//Synth_notes contains the frequency of all the keyboard's notes
		synth_notes[0] = 27.5;
		for (m=1;m<midi_notes.length;m++){
			synth_notes[m]=synth_notes[m-1]*Math.pow(2,1/12);
		}


		document.querySelectorAll("#rec").forEach(toggleRecord);

		function toggleRecord(item){
			item.onclick = record;
		}

		//click one time to start aquiring the midi input signal
		//click a second time to divide the signal in blocks
		function record(){
			send = !send;
			console.log(send + " record");
			if (send){
				navigator.requestMIDIAccess().then(onMIDISuccess);
			}
			else{
				console.log("else");
				while (j < note_to_play.length){
				block[j/10]  = note_to_play.slice(j,j+10);
				j = j+10;
				}
			}
		}

		function onMIDISuccess(midiAccess) {

			console.log(midiAccess);
		    inputs = midiAccess.inputs;
		    outputs = midiAccess.outputs;
		    
		    for (var input of midiAccess.inputs.values()){
		        input.onmidimessage = getMIDIMessage;
		    }
		}

		function getMIDIMessage(midiMessage) {
			message = midiMessage;
			//console.log(message);
			note_array[i]=message.data[1];
			synthMidiInput();
			i++;
		}


		//converts the second value of the midi input in a playable note
		function synthMidiInput(){
			n=0;
			while (n<note_array.length){
				if (note_array[n]<21 | note_array[n]>108){
					//console.log('This is not a midi note');
					note_to_play[n] = 0;
				}else{
					p=0;
					while (midi_notes[p] != note_array[n]){
						p++;
					}
					note_to_play[n] = Math.round(synth_notes[p]);   
				}
				n++;
			}
			return note_to_play;
		}

		//actually playing these notes
		function playBuffer(){
			buffer = audioCtx.createBuffer(1,audioCtx.sampleRate*5,audioCtx.sampleRate);
			data = buffer.getChannelData(0);
			for (i=0;i<data.length;i++){
				data[i] = note_to_play[i];
			}
			bufferSource = audioCtx.createBufferSource();
			bufferSource.buffer = buffer;
			bufferSource.connect(audioCtx.destination);
			bufferSource.loop = true;
			bufferSource.start();
		}

		var playbtn = document.querySelector("#play");
		playbtn.addEventListener("click",playBuffer);
		

	</script>
</body>
</html>