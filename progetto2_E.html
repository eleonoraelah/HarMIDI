<!DOCTYPE html>
<html>
<head>
</head>
<body>
	<div>
		<button id="rec">Rec</button>
		<button id="play">Play</button>
		<button id="harm">Harm</button>
	</div>
	<script type="text/javascript">

		var i=0;
		var note_array = new Array;
		var block = new Array;
		var j = 0; 
		var send=false;

		var duration = new Array;
		var time = new Array;
		var noteOn = new Array;		

		document.querySelectorAll("#rec").forEach(toggleRecord);

		function toggleRecord(item){
			item.onclick = record;
		}

		function record(){
			send = !send;
			console.log(send + " record");
			if (send){
				navigator.requestMIDIAccess().then(onMIDISuccess);
			}
			else{
				console.log("else");
				while (j < note_array.length){
				block[j/10]  = note_array.slice(j,j+10);
				j = j+10;
				}
			}
		}

		//rec = document.getElementById("rec");
		//rec.onclick = record(send);

		//navigator.requestMIDIAccess().then(onMIDISuccess);

		function onMIDISuccess(midiAccess) {

			console.log(midiAccess);
		    inputs = midiAccess.inputs;
		    outputs = midiAccess.outputs;
		    
		    for (var input of midiAccess.inputs.values()){
		        input.onmidimessage = getMIDIMessage;
		    }
		}

		function getMIDIMessage(midiMessage) {
			message = midiMessage;
			if (message.data[0] == 155 || message.data[0] == 139){
				//console.log(message);
				note_array[i]=message.data;
				time[i] = message.timeStamp;
				//console.log("Time "+time[i] + "indice "+ i);
				if (i > 0){
					duration[i] = time[i] - time[i-1];
					console.log(duration[i]+" durata");
					if (note_array[i][0] < note_array[i-1][0]){ //139 < 155 the note has been played
						noteOn[i] = true;
					} else {
						noteOn[i] = false;
					}
				}
				i++;
			}
		}

		document.querySelectorAll("#play").forEach(togglePlay);

		function togglePlay(item){
			item.onclick = startplaying;
		}

		var k = 1;
		var c;
		function startplaying(){
			while (k<noteOn.length){
				if (noteOn[k]){
					console.log(noteOn[k]);
					suona(Math.round(440*Math.pow(2,1/12)**k),duration[k]);
					
					k++;
				} else{
					console.log(noteOn[k]);
					//setTimeout(startplaying, duration[k]+10000);
					suona(Math.round(0),duration[k]);
					
				}
			}
		}
		function suona(freq, howlong){
			c = new AudioContext();
		    osc = c.createOscillator();
		    osc.connect(c.destination);
		    osc.frequency.value = freq;
		    osc.start();
		    osc.stop(Math.round(howlong)/1000);
		    k++;
		    setTimeout(startplaying(), duration[k]+10000);
		}

		/*
		function startplaying(){
			suona(Math.round(440*Math.pow(2,1/12)**k));
		}
		function suona(freq){
			c = new AudioContext();
		    osc = c.createOscillator();
		    osc.connect(c.destination);
		    osc.frequency.value = freq;
		    while (k<noteOn.length){
				console.log("Why isn't it playing?");
				if (noteOn[k]){
					osc.start();
		   	 		osc.stop(Math.round(howlong)/1000);
					setTimeout(suona(Math.round(440*Math.pow(2,1/12)**k)), duration[k]);
					k++;
				} else{
					setTimeout(suona(Math.round(440*Math.pow(2,1/12)**(k+1))), duration[k]);
				}
			}
		}
		*/
	</script>
</body>
</html>